{% extends 'app/base.html' %}
{% load static %}
{%block content%}

<!DOCTYPE html>
<html lang="ja">

<head>
    <title>Chart.js</title>
    <link rel="stylesheet" type="text/css" href="{% static 'app/css/popup.css' %}">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
    <!--Creates the popup body-->
    <div class="popup-overlay">
        <!--Creates the popup content-->
        <div class="popup-content">
            <div id="wrap">
            </div>
            <!--popup's close button-->
            <button class="close">Close</button>
        </div>
    </div>

    <h1>検索条件</h1>
    <form action="{% url 'app:graph' %}" method="POST" enctype="multipart/form-data">{% csrf_token %}
        <table>
            <tr>
                <th>大カテゴリー</th>
                <td>{{ form.big_category }}</td>
            </tr>
            <tr>
                <th>小カテゴリー</th>
                <td>{{ form.small_category }}</td>
            </tr>
        </table>
        <button type="submit" class="btn">検索</button>
    </form>

    <script type="text/javascript" src="{% static 'app/js/popup.js' %}"></script>

    <canvas id=outgoCanvas height="200px"></canvas>
    <script type="text/javascript">

        var drawGraph = function (x, y) {
            /* idが"radar-chart"の要素を取得 */
            var outgoCanvas = document.getElementById("outgoCanvas");
            var ctx = outgoCanvas.getContext('2d')

            var array = []
            {% for tmp in x_axis %}
            array.push("{{ tmp }}")
            {% endfor %}

            var itemMax = Math.max.apply(null, {{ y_axis }})

        /* 上記要素にチャートを描画　*/
        var lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [...array],
                datasets: [{
                    label: "A",
                    pointHitRadius: 15,
                    data: {{ y_axis }},
        },
                    ]
                },
        options: {
            title: {
                display: true,
                    text: 'グラフ'
            },
            scales: {
                yAxes: [{
                    ticks: {
                        suggestedMax: itemMax,
                        suggestedMin: 0,
                        stepSize: 1000,
                        callback: function (value, index, values) {
                            return value + '円'
                        }
                    }
                }]
            },
        }
            });

        outgoCanvas.onclick = function (e) {

            var item = lineChart.getElementAtEvent(e);
            if (!item.length) return; // return if not clicked on slice
            var index = item[0]._index;

            $(".popup-overlay, .popup-content").addClass("active");

            $.ajax({
                url: '{% url "app:ajax_get_item" %}',
                type: 'GET',
                data: {
                    'point_id': index,
                }
            }).done(response => {
                var itemList = response.itemList
                // jQueryによるパターン
                $("#wrap").html("");
                target = $("#wrap")
                for (var n in itemList) {
                    // console.log(n)
                    var text = '<li>';
                    line = itemList[n].item + "/" + itemList[n].small_category + "/" + itemList[n].price;
                    text = text + line + '</li>';
                    $(target).append(text);
                }
            });
        }
        };
        window.onload = function () {
            drawGraph("{{x.0}}", "{{y}}");
        };

    </script>

    <ul>
        {% for o in object_list %}
        <li>{{o}}</li>
        {% endfor %}
    </ul>
</body>

</html>
{%endblock%}



{% block extrajs %}
<script>
    const bigCategoryElement = $('#id_big_category');
    const smallCategoryElement = $('#id_small_category');

    const changeCategory = (select) => {
        // 子カテゴリの選択欄を空にする。
        smallCategoryElement.children().remove();

        $.ajax({
            url: "{% url 'app:ajax_get_category' %}",
            type: 'GET',
            data: {
                'pk': bigCategoryElement.val(),
            }
        }).done(response => {
            // 子カテゴリの選択肢を作成・追加。
            const option = $('<option>');
            option.val("");
            option.text("すべての小カテゴリー");
            smallCategoryElement.append(option);
            for (const smallCategory of response.smallCategoryList) {
                const option = $('<option>');
                option.val(smallCategory['pk']);
                option.text(smallCategory['name']);
                smallCategoryElement.append(option);
            }
            // 指定があれば、そのカテゴリを選択する
            if (select !== undefined) {
                smallCategoryElement.val(select);
            }

        });
    };
    // 大カテゴリのオプション追加をここに書く
    bigCategoryElement.on('change', () => {
        changeCategory();
    });

    // 入力値に問題があって再表示された場合、ページ表示時点で小カテゴリが絞り込まれるようにする
    if (bigCategoryElement.val()) {
        const selectedCategory = smallCategoryElement.val();
        changeCategory(selectedCategory);
    }
</script>
{% endblock %}